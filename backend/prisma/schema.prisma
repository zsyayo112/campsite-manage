// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"  // 开发环境
  // provider = "postgresql"  // 生产环境
  url      = env("DATABASE_URL")
}

// ==================== 用户认证 ====================

model User {
  id           Int      @id @default(autoincrement())
  username     String   @unique
  passwordHash String   @map("password_hash")
  role         String   // admin, operator, driver, coach, marketer
  realName     String?  @map("real_name")
  phone        String?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("users")
}

// ==================== 客户管理 ====================

model Customer {
  id             Int       @id @default(autoincrement())
  name           String
  phone          String    @unique
  wechat         String?
  source         String    // xiaohongshu, wechat, booking_form, other
  tags           String?   // JSON array
  notes          String?
  firstVisitDate DateTime? @map("first_visit_date")
  lastVisitDate  DateTime? @map("last_visit_date")
  totalSpent     Decimal   @default(0) @map("total_spent")
  visitCount     Int       @default(0) @map("visit_count")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  orders   Order[]
  bookings Booking[]

  @@index([name])
  @@index([source])
  @@index([lastVisitDate])
  @@index([createdAt])
  @@map("customers")
}

// ==================== 住宿管理 ====================

model AccommodationPlace {
  id        Int      @id @default(autoincrement())
  name      String
  type      String   // self, external
  address   String?
  phone     String?
  distance  Decimal?
  duration  Int?     // 分钟
  notes     String?
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  orders       Order[]
  shuttleStops ShuttleStop[]

  @@index([type])
  @@map("accommodation_places")
}

// ==================== 项目管理 ====================

model Project {
  id              Int       @id @default(autoincrement())
  name            String
  description     String?
  price           Decimal
  unit            String    // per_person, per_group
  season          String?   // winter, summer, all
  duration        Int       // 分钟
  capacity        Int?      // 场地容量
  isActive        Boolean   @default(true) @map("is_active")
  sortOrder       Int       @default(0) @map("sort_order")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // V2.2/V2.3 新增：活动介绍扩展字段
  coverImage      String?   @map("cover_image")       // 封面图URL
  images          String?   @map("images")            // 图片列表(JSON)
  videos          String?   @map("videos")            // V2.3: 视频列表(JSON)
  highlights      String?   @map("highlights")        // 亮点(JSON数组)
  precautions     String?   @map("precautions")       // 注意事项(JSON数组)
  longDescription String?   @map("long_description")  // 详细介绍
  showInPublic    Boolean   @default(true) @map("show_in_public") // 是否公开展示
  displayOrder    Int       @default(0) @map("display_order")     // V2.3: 展示顺序
  badge           String?   @map("badge")             // V2.3: 标签(热门/推荐/新品)

  orderItems     OrderItem[]
  packageItems   PackageItem[]
  dailySchedules DailySchedule[]

  @@index([season])
  @@index([isActive])
  @@map("projects")
}

// ==================== 套餐管理 ====================

model Package {
  id                Int      @id @default(autoincrement())
  name              String
  subtitle          String?  @map("subtitle")                           // V2.3: 副标题
  description       String?
  longDescription   String?  @map("long_description")                   // V2.3: 详细介绍

  // 价格配置
  price             Decimal
  childPrice        Decimal? @map("child_price")                        // 儿童价格（4岁以下）
  originalPrice     Decimal? @map("original_price")                     // V2.3: 原价（划线价）
  specialPricing    String?  @map("special_pricing")                    // 特殊日期价格配置 JSON

  // V2.3: 多媒体内容
  coverImage        String?  @map("cover_image")                        // 封面图URL
  images            String?  @map("images")                             // 图片列表(JSON数组)
  videos            String?  @map("videos")                             // 视频列表(JSON数组)

  // V2.3: 套餐内容
  includedItems     String?  @map("included_items")                     // 包含项目文字描述(JSON数组)
  highlights        String?  @map("highlights")                         // 套餐亮点(JSON数组)
  schedule          String?  @map("schedule")                           // 行程安排(JSON数组)
  precautions       String?  @map("precautions")                        // 注意事项(JSON数组)

  // 展示配置
  showInPublic      Boolean  @default(true) @map("show_in_public")      // V2.3: 是否公开展示
  showInBookingForm Boolean  @default(true) @map("show_in_booking_form") // 是否在预约表单显示
  displayOrder      Int      @default(0) @map("display_order")          // V2.3: 展示顺序（替代sortOrder）
  badge             String?  @map("badge")                              // V2.3: 标签(推荐/热门/新品)

  // 时间和容量
  duration          Int?     @map("duration")                           // V2.3: 活动时长(分钟)
  minPeople         Int?     @map("min_people")
  maxPeople         Int?     @map("max_people")                         // V2.3: 最多人数

  // 状态
  isActive          Boolean  @default(true) @map("is_active")
  status            String   @default("active")                         // V2.3: active/inactive/draft

  // 关联项目ID
  projectIds        String?  @map("project_ids")                        // V2.3: 包含的项目ID(JSON数组)

  // 兼容旧字段
  sortOrder         Int      @default(0) @map("sort_order")             // 已废弃，使用displayOrder

  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  packageItems PackageItem[]
  orders       Order[]
  bookings     Booking[]

  @@index([status, showInPublic])
  @@index([displayOrder])
  @@map("packages")
}

model PackageItem {
  id        Int      @id @default(autoincrement())
  packageId Int      @map("package_id")
  projectId Int      @map("project_id")
  createdAt DateTime @default(now()) @map("created_at")

  package Package @relation(fields: [packageId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id])

  @@index([packageId])
  @@index([projectId])
  @@map("package_items")
}

// ==================== 订单管理 ====================

model Order {
  id                   Int       @id @default(autoincrement())
  orderNumber          String    @unique @map("order_number")
  customerId           Int       @map("customer_id")
  accommodationPlaceId Int       @map("accommodation_place_id")
  roomNumber           String?   @map("room_number")
  packageId            Int?      @map("package_id")
  bookingId            Int?      @unique @map("booking_id") // 预约来源
  orderDate            DateTime  @map("order_date")
  visitDate            DateTime  @map("visit_date")
  peopleCount          Int       @map("people_count")
  totalAmount          Decimal   @map("total_amount")
  status               String    // pending, confirmed, completed, cancelled
  paymentStatus        String    @map("payment_status") // unpaid, paid, refunded
  notes                String?
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  customer           Customer           @relation(fields: [customerId], references: [id])
  accommodationPlace AccommodationPlace @relation(fields: [accommodationPlaceId], references: [id])
  package            Package?           @relation(fields: [packageId], references: [id])
  booking            Booking?           @relation(fields: [bookingId], references: [id])
  orderItems         OrderItem[]

  @@index([customerId])
  @@index([accommodationPlaceId])
  @@index([packageId])
  @@index([orderDate])
  @@index([visitDate])
  @@index([status])
  @@index([paymentStatus])
  @@index([createdAt])
  @@map("orders")
}

model OrderItem {
  id                 Int       @id @default(autoincrement())
  orderId            Int       @map("order_id")
  projectId          Int       @map("project_id")
  quantity           Int
  unitPrice          Decimal   @map("unit_price")
  subtotal           Decimal
  scheduledTimeStart DateTime? @map("scheduled_time_start")
  scheduledTimeEnd   DateTime? @map("scheduled_time_end")
  coachId            Int?      @map("coach_id")
  createdAt          DateTime  @default(now()) @map("created_at")

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id])
  coach   Coach?  @relation(fields: [coachId], references: [id])

  @@index([orderId])
  @@index([projectId])
  @@index([coachId])
  @@map("order_items")
}

// ==================== 接送调度 ====================

model Vehicle {
  id          Int      @id @default(autoincrement())
  plateNumber String   @unique @map("plate_number")
  vehicleType String   @map("vehicle_type") // 大巴, 中巴, 商务车
  seats       Int
  status      String   // available, maintenance, assigned
  notes       String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  shuttleSchedules ShuttleSchedule[]

  @@map("vehicles")
}

model Driver {
  id        Int      @id @default(autoincrement())
  userId    Int?     @map("user_id")
  name      String
  phone     String
  status    String   // on_duty, off_duty
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  shuttleSchedules ShuttleSchedule[]

  @@map("drivers")
}

model ShuttleSchedule {
  id            Int       @id @default(autoincrement())
  date          DateTime
  batchName     String    @map("batch_name")
  vehicleId     Int       @map("vehicle_id")
  driverId      Int       @map("driver_id")
  departureTime DateTime  @map("departure_time")
  returnTime    DateTime? @map("return_time")
  status        String    // pending, in_progress, completed
  notes         String?
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  vehicle      Vehicle       @relation(fields: [vehicleId], references: [id])
  driver       Driver        @relation(fields: [driverId], references: [id])
  shuttleStops ShuttleStop[]

  @@index([date])
  @@index([vehicleId])
  @@index([driverId])
  @@map("shuttle_schedules")
}

model ShuttleStop {
  id                   Int      @id @default(autoincrement())
  scheduleId           Int      @map("schedule_id")
  accommodationPlaceId Int      @map("accommodation_place_id")
  stopOrder            Int      @map("stop_order")
  passengerCount       Int      @map("passenger_count")
  createdAt            DateTime @default(now()) @map("created_at")

  schedule           ShuttleSchedule    @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  accommodationPlace AccommodationPlace @relation(fields: [accommodationPlaceId], references: [id])

  @@index([scheduleId])
  @@index([accommodationPlaceId])
  @@map("shuttle_stops")
}

// ==================== 行程排期 ====================

model Coach {
  id          Int      @id @default(autoincrement())
  userId      Int?     @map("user_id")
  name        String
  phone       String
  specialties String?  // JSON array
  status      String   // on_duty, off_duty
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  orderItems     OrderItem[]
  dailySchedules DailySchedule[]

  @@map("coaches")
}

model DailySchedule {
  id               Int       @id @default(autoincrement())
  date             DateTime
  orderItemId      Int       @map("order_item_id")
  projectId        Int       @map("project_id")
  startTime        DateTime  @map("start_time")
  endTime          DateTime  @map("end_time")
  coachId          Int?      @map("coach_id")
  participantCount Int       @map("participant_count")
  status           String    // scheduled, in_progress, completed
  notes            String?
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  project Project @relation(fields: [projectId], references: [id])
  coach   Coach?  @relation(fields: [coachId], references: [id])

  @@index([date])
  @@index([projectId])
  @@index([coachId])
  @@map("daily_schedules")
}

// ==================== 内容管理 ====================

model XiaohongshuNote {
  id             Int       @id @default(autoincrement())
  title          String
  content        String
  status         String    // draft, published, deleted
  publishDate    DateTime? @map("publish_date")
  views          Int       @default(0)
  likes          Int       @default(0)
  comments       Int       @default(0)
  collects       Int       @default(0)
  tags           String?   // JSON array
  images         String?   // JSON array
  xiaohongshuUrl String?   @map("xiaohongshu_url")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  @@index([status])
  @@index([publishDate])
  @@index([createdAt])
  @@map("xiaohongshu_notes")
}

// ==================== 客户自助预约 ====================

model Booking {
  id               Int       @id @default(autoincrement())
  bookingCode      String    @unique @map("booking_code") // BK20260129001

  // 客户信息（提交时记录）
  customerName     String    @map("customer_name")
  customerPhone    String    @map("customer_phone")
  customerWechat   String?   @map("customer_wechat")

  // 关联客户（处理后关联）
  customerId       Int?      @map("customer_id")

  // 预约详情
  visitDate        DateTime  @map("visit_date")
  adultCount       Int       @default(1) @map("adult_count")   // V2.2: 成人人数（独立字段）
  childCount       Int       @default(0) @map("child_count")   // 儿童人数（4岁以下）
  peopleCount      Int       @map("people_count")              // 总人数（兼容旧数据）

  // 住宿信息
  hotelName        String?   @map("hotel_name")                // V2.2: 改为可选
  hotelId          Int?      @map("hotel_id")
  roomNumber       String?   @map("room_number")
  accommodationNotes String? @map("accommodation_notes")       // V2.2: 住宿备注（替代酒店选择）

  // 套餐信息
  packageId        Int?      @map("package_id")
  packageName      String?   @map("package_name")

  // 价格信息
  unitPrice        Decimal   @map("unit_price")
  childPrice       Decimal   @default(0) @map("child_price")
  totalAmount      Decimal   @map("total_amount")

  // 定金信息
  depositAmount    Decimal   @default(0) @map("deposit_amount")
  depositPaidAt    DateTime? @map("deposit_paid_at")
  depositCollector String?   @map("deposit_collector")

  // 状态: pending, confirmed, converted, completed, cancelled
  status           String    @default("pending")

  // 备注
  customerNotes    String?   @map("customer_notes")
  operatorNotes    String?   @map("operator_notes")

  // 来源追踪
  source           String    @default("wechat_form") // wechat_form, manual, other

  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // 关联
  customer         Customer? @relation(fields: [customerId], references: [id])
  package          Package?  @relation(fields: [packageId], references: [id])
  order            Order?

  @@index([bookingCode])
  @@index([customerPhone])
  @@index([visitDate])
  @@index([status])
  @@index([createdAt])
  @@map("bookings")
}

// ==================== 站点配置 V2.2 ====================

model SiteConfig {
  id        Int      @id @default(autoincrement())
  key       String   @unique                      // 配置键名
  value     String                                // 配置值（JSON）
  label     String?                               // 显示名称
  group     String   @default("general")          // 分组：general, contact, about, seo
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([group])
  @@map("site_configs")
}
